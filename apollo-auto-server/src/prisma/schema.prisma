generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id           Int            @id @default(autoincrement())
  account      String         @unique
  password     String
  displayName  String
  timezone     String         @default("Asia/Taipei")
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  Token        Token[]
  TelegramToken TelegramToken[]
  Job          Job[]
  ApolloCookie ApolloCookie[]
}

model Token {
  id        Int      @id @default(autoincrement())
  userId    Int
  token     String   @unique @db.VarChar(512)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model TelegramToken {
  id        Int      @id @default(autoincrement())
  userId    Int
  name      String?  @db.VarChar(191)
  botToken  String   @db.VarChar(512)
  chatId    String   @db.VarChar(255)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model ApolloCookie {
  id        Int      @id @default(autoincrement())
  userId    Int      @unique
  value     String   @db.Text // JSON string
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

enum JobType {
  CHECK_IN
  CHECK_OUT
}

enum JobStatus {
  SUCCESS
  FAILED
  SKIPPED
  PENDING
}

model Job {
  id                  Int        @id @default(autoincrement())
  userId              Int
  type                JobType
  startAt             String     @db.Char(5)
  endAt               String?    @db.Char(5)
  data                String? // JSON string
  weekdays            String? // JSON array of weekday numbers (0=Sunday, 6=Saturday), null means all days
  nextExecutionAt     DateTime?
  lastExecutedAt      DateTime?
  lastExecutionStatus JobStatus?
  lastExecutionResult String?    @db.Text // JSON string
  isActive            Boolean    @default(true)
  expiredAt           DateTime?
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, type])
}
